<?xml version="1.0"?> 
<robot name="jax" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <material name="black"><color rgba="0.1 0.1 0.1 1"/></material>
  <material name="white"><color rgba="1 1 1 1"/></material>

  <!--<link name="world"/>

  <joint name="world_to_base" type="fixed">
    <parent link="world"/>
    <child link="base_link"/>
    <origin xyz="0 0 0.23"/>
  </joint> -->

  <link name="base_link">
  <visual>
    <origin xyz="0 0 0.04"/>
    <geometry>
      <mesh filename="package://jax_description/meshes/base_link.stl"
            scale=".001 .001 .001"/>
    </geometry>
    <material name="white"/>
  </visual>

  <collision>
    <origin xyz="0 0 0.04"/>
    <geometry>
      <box size="0.35 0.14 0.08"/>
    </geometry>
  </collision>

  <inertial>
    <origin xyz="0.05 0 0.04"/>
    <mass value="6.0"/>
    <inertia ixx="0.03" iyy="0.06" izz="0.07"
             ixy="0" ixz="0" iyz="0"/>
  </inertial>
  </link>

  <xacro:macro name="jax_leg" params="prefix x_reflect y_reflect side">

    <link name="${prefix}_hip">
      <visual>
        <origin xyz="0 ${0.01 * y_reflect} 0.01"/>
        <geometry><mesh filename="package://jax_description/meshes/${side}_hip.stl" scale=".001 .001 .001"/></geometry>
        <material name="black"/>
      </visual>
      <collision>
        <origin xyz="0 ${-0.02 * y_reflect} 0"/>
        <geometry><sphere radius="0.025"/></geometry>
      </collision>
      <inertial>
        <mass value="0.15"/>
        <origin xyz="0 ${-0.02 * y_reflect} 0"/>
        <inertia ixx="0.0002" iyy="0.0002" izz="0.0002" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <gazebo reference="${prefix}_hip">
      <selfCollide>false</selfCollide>
    </gazebo>

    <joint name="${prefix}_hip_joint" type="revolute">
      <parent link="base_link"/>
      <child link="${prefix}_hip"/>
     <origin xyz="${(0.11 * x_reflect) -.005} ${0.085 * y_reflect} 0.04"/>
      <axis xyz="1 0 0"/>
      <limit lower="-0.6" upper="0.6" effort="30.0" velocity="1.5"/>
      <dynamics damping="1.5" friction="1.0"/>
    </joint>

    <link name="${prefix}_thigh">
      <visual>
        <origin xyz="0 ${-0.039 * y_reflect} 0"/>
        <geometry><mesh filename="package://jax_description/meshes/${side}_thigh.stl" scale=".001 .001 .001"/></geometry>
        <material name="white"/>
      </visual>
      <collision>
        <origin xyz="0 ${-0.039 * y_reflect} -0.065"/>
        <geometry><cylinder radius="0.012" length="0.08"/></geometry>
      </collision>
      <inertial>
        <mass value="0.35"/>
        <origin xyz="0 ${-0.039 * y_reflect} -0.065"/>
        <inertia ixx="0.001" iyy="0.001" izz="0.0003" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <gazebo reference="${prefix}_thigh">
      <selfCollide>false</selfCollide>
    </gazebo>

    <joint name="${prefix}_thigh_joint" type="revolute">
      <parent link="${prefix}_hip"/>
      <child link="${prefix}_thigh"/>
      <origin xyz="0 ${0.050 * y_reflect} 0.01"/>
      <axis xyz="0 -1 0"/>
      <limit lower="-1.2" upper="1.2" effort="35.0" velocity="6.0"/>
      <dynamics damping="0.5" friction="0.0"/>
    </joint>

    <link name="${prefix}_calf">
      <visual>
        <origin xyz="0 ${-0.048 * y_reflect} 0"/>
        <geometry><mesh filename="package://jax_description/meshes/${side}_calf.stl" scale=".001 .001 .001"/></geometry>
        <material name="black"/>
      </visual>
      <collision>
        <origin xyz="0.05 ${-0.043 * y_reflect} -0.045" rpy="0 -0.85 0"/>
        <geometry><cylinder radius="0.012" length="0.13"/></geometry>
      </collision>
      <inertial>
        <mass value="0.25"/>
        <origin xyz="0.05 ${-0.043 * y_reflect} -0.045" rpy="0 -0.85 0"/>
        <inertia ixx="0.0007" iyy="0.0007" izz="0.0002" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <gazebo reference="${prefix}_calf">
      <selfCollide>false</selfCollide>
    </gazebo>

    <joint name="${prefix}_knee_joint" type="revolute">
      <parent link="${prefix}_thigh"/>
      <child link="${prefix}_calf"/>
      <origin xyz="0 ${0.02 * y_reflect} -0.13"/>
      <axis xyz="0 -1 0"/>
      <limit lower="0" upper="1.4" effort="40.0" velocity="6"/>
      <dynamics damping="0.5" friction="0.0"/>
    </joint>

    <link name="${prefix}_foot">
      <collision>
        <origin xyz="0 0 0.005"/>
        <geometry><sphere radius="0.010"/></geometry>
        <surface>
          <friction>
          <ode>
          <mu>0.8</mu>
          <mu2>0.8</mu2>
          </ode>
          </friction>
        </surface>
      </collision>
    </link>

    <joint name="${prefix}_foot_fixed_joint" type="fixed">
      <parent link="${prefix}_calf"/>
      <child link="${prefix}_foot"/>
      <origin xyz="0.095 ${-0.044 * y_reflect} -0.1"/>
    </joint>

    <gazebo reference="${prefix}_foot">
      <mu1>1.2</mu1><mu2>1.2</mu2>
      <kp>100000.0</kp><kd>100.0</kd>
    </gazebo>
  </xacro:macro>

  <xacro:jax_leg prefix="front_right" x_reflect="1" y_reflect="-1" side="right"/>
  <xacro:jax_leg prefix="front_left" x_reflect="1" y_reflect="1" side="left"/>
  <xacro:jax_leg prefix="rear_right" x_reflect="-1" y_reflect="-1" side="right"/>
  <xacro:jax_leg prefix="rear_left" x_reflect="-1" y_reflect="1" side="left"/>

    <ros2_control name="JaxGazeboSystem" type="system">
    <hardware>
      <plugin>gz_ros2_control/GazeboSimSystem</plugin>
    </hardware>
    <xacro:macro name="joint_interface" params="name">
      <joint name="${name}">
        <command_interface name="position"/>
        <state_interface name="position">
          <!-- <param name="initial_value">0.0</param> -->
        </state_interface>
        <state_interface name="velocity"/>
      </joint>
    </xacro:macro>

    <xacro:joint_interface name="front_right_hip_joint"/><xacro:joint_interface name="front_right_thigh_joint"/><xacro:joint_interface name="front_right_knee_joint"/>
    <xacro:joint_interface name="front_left_hip_joint"/><xacro:joint_interface name="front_left_thigh_joint"/><xacro:joint_interface name="front_left_knee_joint"/>
    <xacro:joint_interface name="rear_right_hip_joint"/><xacro:joint_interface name="rear_right_thigh_joint"/><xacro:joint_interface name="rear_right_knee_joint"/>
    <xacro:joint_interface name="rear_left_hip_joint"/><xacro:joint_interface name="rear_left_thigh_joint"/><xacro:joint_interface name="rear_left_knee_joint"/>
  </ros2_control>

  <gazebo>
    <plugin filename="gz_ros2_control-system" name="gz_ros2_control::GazeboSimROS2ControlPlugin">
      <parameters>$(find jax_description)/config/controllers.yaml</parameters>
    </plugin>
  </gazebo>

  <link name="imu_link"> 
    <inertial>
      <mass value="0.001"/>
      <origin xyz="0 0 0"/>
      <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/>
    </inertial>
  </link>
    
  <joint name="base_to_imu" type="fixed">
    <parent link="base_link"/>
    <child link="imu_link"/>
    <origin xyz="0 0 0.03" rpy="0 0 0"/>
  </joint>

  <gazebo reference="imu_link">
    <sensor name="imu_sensor" type="imu">
      <always_on>true</always_on>
      <update_rate>400</update_rate>
      <visualize>false</visualize>
      <imu>
        <angular_velocity>
          <noise type="gaussian">
            <mean>0.0</mean>
            <stddev>0.0002</stddev>
          </noise>
        </angular_velocity>
        <linear_acceleration>
          <noise type="gaussian">
            <mean>0.0</mean>
            <stddev>0.01</stddev>
          </noise>
        </linear_acceleration>
      </imu>
      <plugin filename="ignition-gazebo-imu-system" name="ignition::gazebo::systems::Imu">
        <ros>
          <remapping>~/out:=imu</remapping>
        </ros>
      </plugin>
    </sensor>
  </gazebo>


</robot>